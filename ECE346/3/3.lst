C:\Documents and Settings\Rahil\My Documents\My School\ECE346\3\3.lst - generated by MGTEK Assembler ASM11 V1.26 Build 144 for WIN32 (x86) - Sun Apr 05 23:56:20 2009

    1:                                 *note: program is incomplete
    2:                                 
    3:                                 *Program generates PWM controlled sequence of 1 sec on ("bright") and 2 sec off ("dim").
    4:                                 *The  LED light is "bright" with a 90%
    5:                                 *Duty cycle and "dim" with a 30% duty cycle.
    6:                                 *Uses OC3 (PA_5)for output.
    7:                                 
    8:                                 *EQUATES:
    9:          =00000000              DATA    EQU     $00
   10:          =00000100              MAIN    EQU     $100
   11:          =000000DF              OC1_VEC EQU     $DF
   12:          =0000100E              TCNT    EQU     $100E
   13:          =00001016              TOC1    EQU     $1016
   14:          =0000101A              TOC3    EQU     $101A
   15:          =0000100C              OC1M    EQU     $100C
   16:          =0000100D              OC1D    EQU     $100D
   17:          =00001020              TCTL1   EQU     $1020
   18:          =00001022              TMSK1   EQU     $1022
   19:          =00001023              TFLG1   EQU     $1023
   20:          =00000080              OC1F    EQU     %10000000
   21:          =00000080              OC1I    EQU     %10000000
   22:                                 
   23:          =00000020              OC3I    EQU     %00100000
   24:          =00000020              OC3F    EQU     %00100000
   25:                                 
   26:          =00000064              ONE_CNT  EQU      100   ;10 MS * 100 = 1 SEC
   27:          =000000C8              ZERO_CNT EQU      200   ;10 MS * 200 = 2 SEC
   28:          =00004E20              TIM_BASE EQU    20000   ;0.5 US *20000 = 10 MS
   29:          =00004650              T_90     EQU    18000   ;90% duty cycle @(T=10MS) = 9 ms = 18000
   30:          =00001770              T_30     EQU     6000
   31:          =000003E8              OFFSET   EQU     1000   ;.5 ms offset
   32:                                 
   33:                                 
   34:          =00000000                      ORG DATA
   35:     0000 +0001                  CNTR            RMB     1   ;TIME BASE COUNTER (MESSAGE)
   36:     0001 +0002                  PULS_WIDTH      RMB     2   ;PULSEWIDTH/TIMEBASE = DUTYCYCLE(MESSAGE)
   37:                                 
   38:     0003 +0001                  CNTR2           RMB     1
   39:     0004 +0001                  DATA2           RMB     1
   40:                                 
   41:                                 
   42:          =00000100                      ORG MAIN
   43:                                 ;initializations
   44:                                 *JUMP TABLE INITIALIZAITON
   45:     0100 86 7E                          LDAA    #$7E            ;SET UP OC1 JUMP TABLE    
   46:     0102 97 DF                          STAA    OC1_VEC         ;FOR JMP
   47:     0104 CC 0160                        LDD     #OC1_SVC        ;TO
   48:     0107 DD E0                          STD     OC1_VEC+1       ;OC1 INTERRUPT SERVICE
   49:                                 *PWM INITIALIZATION   
   50:     0109 86 20                          LDAA    #%00100000      ;SET UP OC1M 
   51:     010B B7 100C                        STAA    OC1M            ;AND OC1D TO PRODUCE  A 1 ON PA_5 (OC3)
   52:     010E B7 100D                        STAA    OC1D            ;AND 
   53:     0111 86 20                          LDAA    #%00100000      ;SET UP OC3 TO CLEAR (PA_5)
   54:     0113 B7 1020                        STAA    TCTL1           ;ON TOC3 COMPARE
   55:                                 *TOC1 INITIALIZATION        
   56:     0116 FC 100E                        LDD     TCNT            ;GET CURRENT VALUE OF TCNT
   57:     0119 C3 03E8                        ADDD     #OFFSET        ;ADD .5 MS OFFSET TO
   58:     011C FD 1016                        STD     TOC1            ;SET UP  TOC1 FOR FIRST INTERRUPT
   59:                                 *OC1 INTERRUPT INITIALIZATION        
   60:     011F 86 80                          LDAA    #OC1I           ;SET UP OC1 INTERRUPT
   61:     0121 B7 1022                        STAA    TMSK1           ;ENABLE OC1 IN MASK REGISTER
   62:     0124 86 80                          LDAA    #OC1F           ;SET UP TO CLEAR
   63:     0126 B7 1023                        STAA    TFLG1           ;OC1  INTERRUPT FLAG
   64:                                 *OC3 INTERRUPT INITIALIZATION        
   65:     0129 86 20                          LDAA    #OC3I           ;SET UP OC3 INTERRUPT
   66:     012B B7 1022                        STAA    TMSK1           ;ENABLE OC3 IN MASK REGISTER
   67:     012E 86 20                          LDAA    #OC3F           ;SET UP TO CLEAR
   68:     0130 B7 1023                        STAA    TFLG1           ;OC3  INTERRUPT FLAG
   69:                                 
   70:     0133 0E                             CLI                     ;ENABLE SYSTEM INTERRUPT
   71:                                 
   72:                                 ;main
   73:     0134 7F 0003                CLCNTR2 CLR     CNTR2           ;CLEAR COUNTER
   74:     0137 7C 0003                LOOP    INC     CNTR2           ;if(cntr<50){cntr++} else {cntr=0}
   75:     013A 96 03                          LDAA    CNTR2
   76:     013C 81 32                          CMPA    #50
   77:     013E 27 F4                          BEQ     CLCNTR2
   78:     0140 26 F5                          BNE     LOOP
   79:                                         ;count up/down
   80:                                 
   81:                                 ;interrupts
   82:                                 *
   83:                                 *       TWO STATE MACHINE       
   84:                                 *
   85:     0142 CC 4650                STATE1  LDD     #T_90           ;SET UP FOR 90% DC
   86:     0145 DD 01                          STD     PULS_WIDTH      ; 
   87:     0147 86 64                          LDAA    #ONE_CNT        ;SET UP 1 SECOND DELAY 
   88:     0149 97 00                          STAA    CNTR
   89:     014B 7D 0000                LOOP1   TST     CNTR            ;CHECK COUNTER  
   90:     014E 26 FB                          BNE     LOOP1           ;WAIT FOR ZERO COUNT
   91:                                         
   92:     0150 CC 1770                STATE0  LDD     #T_30           ;SET UP FOR 30%VDC
   93:     0153 DD 01                          STD     PULS_WIDTH
   94:     0155 86 64                          LDAA    #ONE_CNT       ;SET UP 2 SEC DELAY
   95:     0157 97 00                          STAA    CNTR
   96:     0159 7D 0000                LOOP0   TST     CNTR            ;CHECK COUNTER 
   97:     015C 26 FB                          BNE     LOOP0           ;WAIT FOR ZERO COUNT
   98:     015E 20 E2                          BRA     STATE1          ;ELSE START OVER -ENDLESS LOOP
   99:                                     
  100:                                 *       OC1 INTERUPPT SERVICE ROUTINE
  101:                                 *       INTERRUPTS EVERY 10 MS AND DECREMENTS A COUNTER
  102:                                 *       PROVIDES A TIME BASE EVENT EVERY 10 MS
  103:                                 *       SETUPS TOC3 FOR COMPARE AFTER (PUL_WIDTH) TIME UNITS 
  104:                                     
  105:     0160 86 80                  OC1_SVC LDAA    #OC1F           ;SET UP TO 
  106:     0162 B7 1023                        STAA    TFLG1           ;CLEAR OC1F
  107:                                 
  108:     0165 DC 01                          LDD     PULS_WIDTH      ;SET UP PULSE WIDTH
  109:     0167 F3 1016                        ADDD    TOC1            ;ADD CURRENT LOCATION
  110:     016A FD 101A                        STD     TOC3            ;AND STORE IN TOC3
  111:                                 
  112:     016D FC 1016                        LDD     TOC1            ;SET UP FOR NEXT INTERRUPT
  113:     0170 C3 4E20                        ADDD    #TIM_BASE       ;ADD TIMEBASE (10 MS)
  114:     0173 FD 1016                        STD     TOC1            ;AND STORE
  115:                                 
  116:     0176 7A 0000                        DEC     CNTR            ;DEC TIME BASE COUNTER
  117:     0179 3B                             RTI                     ;EXIT
  118:                                 
  119:     017A 86 20                  OC3_SVC LDAA    #OC3F           ;SET UP TO 
  120:     017C B7 1023                        STAA    TFLG1           ;CLEAR OC3F
  121:                                 
  122:     017F FC 101A                        LDD     TOC3            ;SET UP FOR NEXT INTERRUPT
  123:     0182 C3 4E20                        ADDD    #TIM_BASE       ;ADD TIMEBASE (10 MS)
  124:     0185 FD 101A                        STD     TOC3            ;AND STORE
  125:                                         
  126:                                         ;LDAA   CNTR2*5
  127:                                         ;STAA   DATA2
  128:                                 
  129:     0188 3B                             RTI
  130:                                         

Symbols:
clcntr2                         *00000134
cntr                            *00000000
cntr2                           *00000003
data                            *00000000
loop                            *00000137
loop0                           *00000159
loop1                           *0000014b
main                            *00000100
oc1_svc                         *00000160
oc1_vec                         *000000df
oc1d                            *0000100d
oc1f                            *00000080
oc1i                            *00000080
oc1m                            *0000100c
oc3f                            *00000020
oc3i                            *00000020
offset                          *000003e8
one_cnt                         *00000064
puls_width                      *00000001
state1                          *00000142
t_30                            *00001770
t_90                            *00004650
tcnt                            *0000100e
tctl1                           *00001020
tflg1                           *00001023
tim_base                        *00004e20
tmsk1                           *00001022
toc1                            *00001016
toc3                            *0000101a


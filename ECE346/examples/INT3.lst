C:\Documents and Settings\Rahil\My Documents\My School\ECE346\examples\INT3.lst - generated by MGTEK Assembler ASM11 V1.26 Build 144 for WIN32 (x86) - Sun Mar 01 01:54:31 2009

    1:          =000000D9              OC3_VEC         EQU     $00D9   ; pseudo-vector location for OC3        
    2:          =00000000              DATA            EQU     $0      ; Start of data segment
    3:          =00000100              MAIN            EQU     $100    ; Start of code segment
    4:                                 
    5:          =0000FFB8              OUTA            EQU     $FFB8
    6:          =0000FFCD              INCHAR          EQU     $FFCD
    7:                                 
    8:                                 * 6811 special register definitions
    9:                                 
   10:          =00001003              PORTC           EQU     $1003
   11:          =00001007              DDRC            EQU     $1007
   12:                                 
   13:          =0000100E              TCNT            EQU     $100E   ; Free running counter
   14:                                 
   15:          =0000101A              TOC3            EQU     $101A   ; Output compare register
   16:                                 
   17:          =00001020              TCTL1           EQU     $1020
   18:          =00001022              TMSK1           EQU     $1022
   19:          =00001023              TFLG1           EQU     $1023
   20:                                 
   21:                                 * Masks for manipulating output compare interrupts
   22:          =00000020              OC3F            EQU     %00100000
   23:          =00000020              OC3I            EQU     %00100000
   24:                                 * Some definitions used for time base and pulse width 
   25:                                 
   26:          =00000064              ONE_CNT         EQU     100        ;10 MS * 100 = 1 SEC
   27:          =000000C8              ZERO_CNT        EQU     200        ;10 MS * 200 = 2 SEC
   28:          =00004E20              TIM_BASE        EQU     20000      ;0.5 US *20000 = 10 MS
   29:          =00002710              OFFSET          EQU     10000      ;0.5us *10000 = 5 ms
   30:                                 
   31:          =00000000                      ORG DATA
   32:     0000 +0001                  CNTR    RMB     1                       ;TIME BASE COUNTER 
   33:     0001 +0001                  STATE   RMB     1                       ;INTERRUPT STATE VARIABLE
   34:                                         
   35:                                 
   36:          =00000100                      ORG MAIN
   37:                                 *DATA INITIALIZATION
   38:     0100 86 00                          LDAA    #0                      ;CLEAR STATE AND COUNTER VALUES
   39:     0102 97 01                          STAA    STATE
   40:     0104 97 00                          STAA    CNTR
   41:                                 
   42:                                 *PORT C INITIALIZATION       
   43:     0106 86 01                          LDAA    #%00000001              ;SET UP PORTC_0 FOR 
   44:     0108 B7 1007                        STAA    DDRC                    ;OUTPUT
   45:     010B 4F                             CLRA                            ;AND 
   46:     010C B7 1003                        STAA    PORTC                   ;OUTPUT A ZERO
   47:                                 
   48:                                 *---------------- Interrupt initialization ----------------------------
   49:                                 
   50:                                 *JUMP TABLE INITIALIZATION
   51:     010F 86 7E                          LDAA    #$7E                    ;SET UP OC3 JUMP TABLE    
   52:     0111 97 D9                          STAA    OC3_VEC                 ;FOR JMP
   53:     0113 CC 0136                        LDD     #OC3_SVC                ; TO
   54:     0116 DD DA                          STD      OC3_VEC+1              ;OC3 INTERRUPT SERVICE
   55:                                 
   56:                                 *OC3 INTERRUPT INITIALIZATION        
   57:     0118 86 20                          LDAA    #OC3I                   ;SET UP OC3 INTERRUPT
   58:     011A B7 1022                        STAA    TMSK1                   ;ENABLE OC3 IN MASK REGISTER
   59:     011D 86 20                          LDAA    #OC3F                   ;SET UP TO CLEAR
   60:     011F B7 1023                        STAA    TFLG1                   ;OC3  INTERRUPT FLAG
   61:                                 
   62:                                 *TOC3 INITIALIZATION        
   63:     0122 FC 100E                        LDD     TCNT                    ;GET CURRNT VALUE OF TCNT
   64:     0125 C3 2710                        ADDD   #OFFSET                  ;ADD 5 MS OFFSET
   65:     0128 FD 101A                        STD     TOC3                    ;SET UP  TOC3
   66:                                 
   67:     012B 0E                             CLI                             ;ENABLE SYSTEM INTERRUPT
   68:                                 *--------------- End Interrupt initialization ------------------------
   69:                                         
   70:                                 
   71:     012C BD FFCD                INPUT   JSR     INCHAR                  ;GET CHARACTER FROM USER
   72:     012F 81 51                          CMPA    #'Q'                    ;IF = Q THEN EXIT PROGRAM
   73:     0131 27 02                          BEQ     ENDP
   74:     0133 20 F7                          BRA     INPUT                   ;OTHERWISE GET INPUT AGAIN
   75:                                 
   76:     0135 3F                     ENDP    SWI
   77:                                 
   78:                                 * OC3 INTERUPT SERVICE ROUTINE INTERRUPTS EVERY 10 MS AND 
   79:                                 * DECREMENTS A COUNTER PROVIDES A TIME BASE EVENT EVERY 10 MS
   80:                                 *        
   81:     0136 86 20                  OC3_SVC LDAA    #OC3F         ;SET UP TO 
   82:     0138 B7 1023                        STAA    TFLG1         ;CLEAR OC3F
   83:                                 
   84:     013B FC 101A                        LDD     TOC3          ;SET UP FOR NEXT INTERRUPT
   85:     013E C3 4E20                        ADDD   #TIM_BASE      ;ADD TIMEBASE (10 MS)?
   86:     0141 FD 101A                        STD     TOC3          ;AND STORE 
   87:                                 *-----------------------------
   88:     0144 96 01                          LDAA    STATE           ;LOAD STATE
   89:     0146 81 01                          CMPA    #1              
   90:     0148 27 13                          BEQ     TWO             ;STATE - 1 = 0? Y-> GO TO STATE TWO     
   91:                                                                 ;N-> GO TO STATE ONE
   92:                                 
   93:                                 *       TWO STATE MACHINE       
   94:     014A 96 00                  ONE     LDAA    CNTR            ;IF CNTR NOT = 0
   95:     014C 26 20                          BNE     OC3END          ;EXIT INTERRUPT
   96:                                         
   97:     014E 86 64                          LDAA    #ONE_CNT       ;CNTR =  ONE_CNT 
   98:     0150 97 00                          STAA    CNTR
   99:                                         
  100:     0152 86 01                          LDAA    #1              ;SET NEXT STATE
  101:     0154 97 01                          STAA    STATE   
  102:                                         
  103:     0156 86 01                          LDAA    #%00000001      ;SET UP FOR '1' OUT
  104:     0158 B7 1003                        STAA    PORTC
  105:                                 
  106:     015B 20 11                          BRA     OC3END
  107:                                 
  108:                                 
  109:     015D 96 00                  TWO     LDAA    CNTR
  110:     015F 26 0D                          BNE     OC3END  
  111:                                 
  112:     0161 86 C8                          LDAA    #ZERO_CNT       ;CNTR = ZERO_CNT
  113:     0163 97 00                          STAA    CNTR
  114:                                         
  115:     0165 86 00                          LDAA    #0              ;SET NEXT STATE
  116:     0167 97 01                          STAA    STATE
  117:                                 
  118:     0169 86 00                          LDAA    #%00000000      ;SET UP FOR '0' OUT
  119:     016B B7 1003                        STAA    PORTC     
  120:                                 
  121:     016E 7A 0000                OC3END  DEC     CNTR          ;DEC TIME BASE COUNTER
  122:     0171 3B                             RTI                   ;EXIT

Symbols:
cntr                            *00000000
data                            *00000000
ddrc                            *00001007
endp                            *00000135
inchar                          *0000ffcd
input                           *0000012c
main                            *00000100
oc3_svc                         *00000136
oc3_vec                         *000000d9
oc3end                          *0000016e
oc3f                            *00000020
oc3i                            *00000020
offset                          *00002710
one_cnt                         *00000064
portc                           *00001003
state                           *00000001
tcnt                            *0000100e
tflg1                           *00001023
tim_base                        *00004e20
tmsk1                           *00001022
toc3                            *0000101a
two                             *0000015d
zero_cnt                        *000000c8

